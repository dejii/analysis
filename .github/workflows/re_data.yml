name: analysis

on:
  push:
    branches: [ main ]

  schedule:
    - cron: '0 0 * * *'

  workflow_dispatch:

env:
  DBT_PROFILES_DIR: ${{ github.workspace }}
  RE_DATA_CONFIG_DIR: ${{ github.workspace }}
  RE_DATA_SEND_ANONYMOUS_USAGE_STATS: 0
  RE_CLOUD_API_KEY: ${{ secrets.RE_CLOUD_API_KEY }}
  SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
  SNOWFLAKE_DBT_PASSWORD: ${{ secrets.SNOWFLAKE_DBT_PASSWORD }}


jobs:

  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v1
        with:
          python-version: "3.7.x"

      - name: Install re_data and python dependencies
        working-directory: .
        run: |
          pip install dbt-snowflake
          pip install re_data
          pip install re_cloud
          pip install plotly
          pip install pandas
          
      - name: Run dbt
        working-directory: .
        run: |
          echo $DBT_PROFILES_DIR
          echo $SNOWFLAKE_ACCOUNT
          dbt --version
          dbt deps
          dbt run --select package:analysis
          dbt run-operation export_exceptions
      
      - name: Run re_data
        working-directory: views
        run: |
          python exceptions.py
          re_cloud upload custom --file index.html --name exceptions